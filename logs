#!/bin/bash

RED='\033[0;31m'
NC='\033[0m'
UUIDRegex="[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"

if [[ $1 = -h ]]; then
	echo -e "${RED}logs <file> ([c] [in] <file>)${NC}"
	echo Give list of strings to exclude/include from the file.
	echo
	echo "c  -> toggle inclusion of colour. Default is to give coloured output. Using c once will disable it on strings going forward. Using c again will enable it for the following strings, and so on."
	echo "in -> include following file. Default is exclude."
	exit 0
fi

firstQuery=
query=""
in=
replace=

declare -a inArray

colour=true
file=$1
shift 1 # Exclusions from now on

while : ; do
	line="$1"
	if [[ "$line" = "" ]]; then
		break
	elif [[ "$line" = "c" ]]; then
		if [[ "$colour" = true ]]; then
			colour=false
		else
			colour=true
		fi
	elif [[ "$line" != "in" ]]; then
		query+=" | grep -v \"$line\""
	else
		in+=" | grep \"$2\""
		inArray+=("$2")
		shift 1
	fi
	shift 1
done

function deSpace {
	arg=$1
	arg="${arg#"${arg%%[![:space:]]*}"}"
	arg="${arg%"${arg##*[![:space:]]}"}"
	echo $arg
}

clusterTxt=$(dirname $(dirname $(dirname $(realpath $file))))/cluster.txt
if [[ ! -f $clusterTxt ]]; then
	return
fi

lineNumber=$(grep -n "^Cluster$" $clusterTxt | head -n 1 | cut -d ':' -f 1)
declare -A SGNames

while read SG; do
	name=$(deSpace $(echo $SG | cut -d'|' -f 3))
	id=$(deSpace $(echo $SG | cut -d'|' -f 2))

	if [[ -z "${SGNames[$name]}" ]]; then
		SGNames[$name]=true
		replace+=" | sed 's/$id/$name/g'"
	fi
done < <(sed -n "4,$((lineNumber-2))p" $clusterTxt)

while read CC; do
	name=$(deSpace $(echo $CC | cut -d'|' -f 6))
	id=$(deSpace $(echo $CC | cut -d'|' -f 5))

	replace+=" | sed 's/$id/$name/g'"
done < <(sed -n "4,$((lineNumber-2))p" $clusterTxt)

command="cat $file $replace $query $in"
if [[ $colour = true ]]; then
	for value in "${inArray[@]}"; do
		command+=" | grep --color=always \"$value\""
	done
fi

set -x
(eval "$command") | tail -n 100